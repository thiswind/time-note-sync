### **个人跨端日志同步管理工具 - 需求与技术路线文档 (修订版)**

#### **一、核心需求 (修订后)**

**核心目标：** 构建一个网页端工具，用于创建、编辑和管理个人日志/备忘，并实现与 iPhone 日历的双向同步，同时支持将日志内容导出到 iPhone 备忘录。

##### **1. 核心功能需求**

*   **网页端日志管理：**
    *   提供一个简洁的网页界面，用于**手动创建、查看、编辑和删除**日志条目。
    *   日志条目应包含**标题**、**内容**和**日期**三个核心字段。
    *   支持按日期对日志进行归档和浏览，实现“按天查阅”。
*   **双向同步功能：**
    *   **正向同步 (网页 → iPhone)：** 网页端创建或修改的日志，应自动或通过手动触发同步到 iPhone 的日历应用中，作为日历事件存在。
    *   **反向同步 (iPhone → 网页)：** 在 iPhone 日历中对同步过去的事件进行的修改（如标记完成、添加备注），应能自动同步回网页端，保持数据一致性。
*   **数据导出与跳转：**
    *   支持将单条或多条日志内容**一键导出/同步**到 iPhone 的备忘录应用。
    *   提供从网页端**一键跳转**至 iPhone 原生应用（日历、备忘录）中对应内容的功能，方便快速查看和操作。
*   **数据隐私与安全：**
    *   所有数据仅个人可访问，需提供身份验证机制（如密码）防止未授权访问。
    *   数据传输过程需加密（HTTPS）。

##### **2. 非功能需求**

*   **开发与维护成本低：** 优先采用成熟、现成的库和工具，避免从零开发复杂协议（如 CalDAV）。
*   **操作便捷性：** 同步流程应尽可能自动化，减少用户手动操作步骤。
*   **长期兼容性与可移植性：** 基于行业标准协议（如 CalDAV、HTTPS）构建，确保能适配未来的系统升级和设备更换。
*   **无额外安装成本：** 用户端仅需使用浏览器和 iPhone 原生应用（日历、备忘录、快捷指令），无需安装任何第三方软件。

#### **二、技术路线 (修订后)**

##### **1. 整体架构 (修订后)**

**核心逻辑：** 用户在**网页端**通过表单**手动创建/编辑日志** → 数据存储在**后端** → 通过**CalDAV 协议**与 **iPhone 日历**进行**双向同步** → 可选通过**快捷指令**将内容**同步至 iPhone 备忘录**。整个系统由一个部署在云端的 Flask 应用作为核心枢纽。

##### **2. 分模块技术方案 (修订后)**

###### **(1) 网页端日志管理模块 (Flask + 前端)**

*   **后端 (Flask)：**
    *   提供 RESTful API 或直接的模板渲染，支持日志的 CRUD (创建、读取、更新、删除) 操作。
    *   负责与数据库交互，存储日志数据。
    *   核心依赖：Flask (Web 框架), SQLite (轻量级数据库)。
*   **前端 (HTML + CSS + JavaScript)：**
    *   构建一个用户友好的界面，包含日志列表、日志详情、创建/编辑表单。
    *   实现按日期归档和筛选的功能。
    *   提供“同步到日历”、“导出到备忘录”、“跳转至 iPhone”等操作按钮。
    *   核心依赖：任何轻量级前端框架或纯 JavaScript。

###### **(2) 日历数据生成与双向同步模块 (核心)**

*   **数据格式：** 日志数据在同步到日历时，将被转换为 `ics` (iCalendar) 格式，这是日历数据交换的标准格式。每个日志条目对应一个日历事件。
*   **后端 CalDAV 服务 (Flask + caldav-library)：**
    *   这是实现双向同步的关键。Flask 应用将集成 `caldav-library` (或类似的 CalDAV 服务器库)，以提供一个符合 CalDAV 协议的网络服务。
    *   该服务负责处理来自 iPhone 的 CalDAV 请求（如获取事件列表、创建、更新、删除事件），并将这些操作映射到后端的数据库操作。
*   **正向同步 (网页 → iPhone)：**
    *   用户在网页端保存日志后，Flask 应用将其存入数据库，并同时更新 CalDAV 服务可访问的事件列表。
    *   iPhone 上配置的 CalDAV 账户会定期或手动触发同步，从而拉取到新的或更新的事件。
*   **反向同步 (iPhone → 网页)：**
    *   用户在 iPhone 日历中修改了一个同步过来的事件（例如，标记为完成、更改标题或添加备注）。
    *   iPhone 会通过 CalDAV 协议将这个变更推送到 Flask 应用提供的 CalDAV 服务。
    *   Flask 应用接收到变更后，更新其数据库中的对应日志条目。
*   **核心依赖：** `caldav-library` (或 `radicale` 等 CalDAV 服务器实现), `ics` (用于生成 ics 文件), SQLite。

###### **(3) iPhone 端集成模块 (同步与跳转)**

*   **CalDAV 账户配置：**
    *   在 iPhone 上，用户需要手动添加一个 CalDAV 账户。
    *   服务器地址填写为你的 Vercel 应用提供的 CalDAV 服务 URL (例如 `https://你的-vercel-app.vercel.app/caldav`)。
    *   输入在你的 Flask 应用中设置的用户名和密码进行身份验证。
*   **一键跳转与自动填充 (快捷指令)：**
    *   **跳转至日历：** 可以通过 `URL Scheme` (如 `calshow://`) 实现，但精确跳转到特定日期的事件比较复杂。更可靠的方式是依赖 CalDAV 同步后，用户直接打开日历 App 查看。
    *   **导出/同步至备忘录：**
        1.  在 iPhone “快捷指令” App 中，创建一个新的快捷指令。
        2.  配置该快捷指令以“接收文本”作为输入，然后执行“创建备忘录”或“添加到备忘录”的操作。
        3.  开启该快捷指令的“通过链接访问”功能，生成一个 `shortcuts://` 开头的 URL。
        4.  在 Flask 前端，为每篇日志生成一个包含日志标题和内容的跳转链接。用户点击后，会调用该快捷指令并自动填充内容到备忘录。
*   **核心依赖：** iPhone 日历 App, iPhone 备忘录 App, iPhone 快捷指令 App。

###### **(4) 云端部署与隐私保护模块**

*   **部署平台：** Vercel 或 Netlify。这两个平台对 Flask 应用有良好的支持，且提供免费计划、自动 HTTPS 和便捷的 CI/CD。
*   **部署配置：**
    *   项目文件应包含 Flask 应用代码、`requirements.txt` (列出所有 Python 依赖，如 `Flask`, `caldav`, `ics`, `Flask-SQLAlchemy` 等)。
    *   需要创建 `vercel.json` 或 `netlify.toml` 配置文件，指定应用的启动命令和构建逻辑。
*   **隐私保护：**
    *   **身份验证：** CalDAV 服务必须启用身份验证（用户名/密码）。Flask 应用需要实现一个简单的身份验证中间件来保护 CalDAV 端点。
    *   **环境变量：** 将所有敏感信息（如数据库连接字符串、CalDAV 用户名密码、会话密钥等）存储在部署平台提供的环境变量中，切勿硬编码在代码里。
    *   **HTTPS：** 依赖 Vercel/Netlify 提供的免费 SSL 证书，确保所有数据传输都是加密的。
*   **核心依赖：** Vercel 或 Netlify 平台, 环境变量管理。

#### **三、关键流程 (修订后)**

1.  **日志创建与同步流程：**
    *   用户在电脑/手机浏览器打开网页端工具。
    *   用户填写日志标题、内容，选择日期，点击“保存并同步”。
    *   网页端将数据发送到 Flask 后端。
    *   后端将日志保存到数据库。
    *   iPhone 上的 CalDAV 账户定期同步，从后端的 CalDAV 服务拉取到新日志对应的日历事件，显示在 iPhone 日历中。

2.  **日志修改与反向同步流程：**
    *   用户在 iPhone 日历中找到同步过来的事件，进行修改（如添加备注“已完成”）并保存。
    *   iPhone 自动（或用户手动触发）将变更通过 CalDAV 协议推送到 Flask 后端的 CalDAV 服务。
    *   后端解析请求，根据事件的唯一标识符（UID）找到对应的日志条目，并更新数据库中的内容。
    *   用户刷新网页端，即可看到从 iPhone 同步回来的修改。

3.  **日志导出到备忘录流程：**
    *   用户在网页端查看某篇日志。
    *   点击“导出到备忘录”按钮。
    *   浏览器打开一个 `shortcuts://` URL，其中包含了日志的标题和内容作为参数。
    *   该 URL 唤起 iPhone 上的“快捷指令”App，并执行预设的指令，将内容自动填充到一个新的或已有的备忘录中。

#### **四、依赖清单 (修订后)**

| 类别 | 核心依赖/工具 | 用途 |
| :--- | :--- | :--- |
| **后端框架** | Flask | 构建 Web 应用和 API 接口。 |
| **数据库** | SQLite | 轻量级存储日志数据。 |
| **日历协议** | `caldav-library` (或 `radicale`) | 提供 CalDAV 服务器功能，实现双向同步。 |
| **日历数据格式** | `ics` (Python 库) | 生成和解析 iCalendar (.ics) 文件。 |
| **部署平台** | Vercel 或 Netlify | 免费部署 Flask 应用，提供 HTTPS。 |
| **移动端工具** | iPhone 日历、备忘录、快捷指令 | 数据同步目标和本地操作终端。 |
| **前端技术** | HTML, CSS, JavaScript | 构建网页端用户界面。 |

